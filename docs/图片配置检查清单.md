# 图片配置检查清单

## ✅ 已完成的修复

### 1. 图片 URL 处理工具 (`frontend/src/utils/image.js`)
- ✅ 修复了重复路径问题（`/api/uploads//api/uploads/`）
- ✅ 支持多种路径格式：
  - 完整 URL（`http://` 或 `https://`）
  - 已包含 `/api/uploads/` 的路径（自动清理重复）
  - 以 `/uploads/` 开头的路径
  - 以 `uploads/` 开头的路径
  - 以 `upload/` 开头的路径
  - 其他相对路径（默认添加到 `uploads` 目录）

### 2. 后台图片上传 URL 配置
所有后台页面的上传 URL 已统一使用环境变量：

#### ✅ 已修复的文件：
- `frontend/src/views/admin/News.vue`
- `frontend/src/views/admin/Company.vue`
- `frontend/src/views/admin/Laboratory.vue`
- `frontend/src/views/admin/CertificationCategory.vue`

#### ✅ 已正确配置的文件：
- `frontend/src/views/admin/Certification.vue`
- `frontend/src/views/admin/Certificate.vue`
- `frontend/src/views/admin/EnterpriseAdvantage.vue`
- `frontend/src/views/admin/Honor.vue`

### 3. 上传 URL 配置格式
```javascript
const uploadUrl = `${import.meta.env.VITE_API_BASE_URL || (import.meta.env.DEV ? 'http://localhost:8082/api' : '/api')}/file/upload`
```

### 4. 后端文件上传配置
- **开发环境**：`D:/workspace/pan/uploads/`
- **生产环境**：`/www/wwwroot/www.tht-lab.com.cn/uploads/`
- **返回路径格式**：`/uploads/xxx.png`

## 📋 检查清单

### 前端检查

#### 1. 图片显示功能
- [x] 前台首页图片显示
- [x] 前台认证服务页面图片显示
- [x] 前台新闻页面图片显示
- [x] 前台荣誉资质页面图片显示
- [x] 前台证书页面图片显示
- [x] 前台关于我们页面图片显示
- [x] 前台实验室页面图片显示
- [x] 后台所有管理页面图片显示

#### 2. 图片上传功能
- [x] 后台认证服务管理 - 图片上传
- [x] 后台新闻管理 - 图片上传
- [x] 后台公司信息管理 - Logo 和二维码上传
- [x] 后台实验室管理 - 图片上传
- [x] 后台认证分类管理 - 图标上传
- [x] 后台荣誉资质管理 - 图片上传
- [x] 后台证书管理 - 证书文件上传
- [x] 后台企业优势管理 - 图标上传

#### 3. 图片路径处理
- [x] `getImageUrl()` 函数正确处理所有路径格式
- [x] `processImageUrls()` 函数批量处理图片路径
- [x] 所有页面都使用 `getImageUrl()` 处理图片路径

### 后端检查

#### 1. 文件上传接口
- [x] `/api/file/upload` - 通用文件上传
- [x] `/api/admin/certificate/upload` - 证书文件上传
- [x] 返回路径格式：`/uploads/xxx.png`

#### 2. 文件存储路径
- [x] 开发环境：`D:/workspace/pan/uploads/`
- [x] 生产环境：`/www/wwwroot/www.tht-lab.com.cn/uploads/`
- [x] 自动判断环境并选择正确的路径

#### 3. 静态资源映射
- [x] `/api/uploads/**` 映射到文件系统
- [x] 支持图片访问：`https://www.tht-lab.com.cn/api/uploads/xxx.png`

## 🔧 线上环境配置

### 1. 服务器目录结构
```
/www/wwwroot/www.tht-lab.com.cn/
├── dist/                    # 前端文件
│   ├── index.html
│   └── assets/
└── uploads/                 # 图片文件（与 dist 同级）
    ├── *.jpg, *.png         # 根目录图片
    ├── icon/                # 图标目录
    │   ├── certification/
    │   └── certification_service/
    ├── images/
    ├── img/
    └── certificates/        # 证书文件（如果有）
```

### 2. 文件权限设置
```bash
# 设置目录权限
chown -R www:www /www/wwwroot/www.tht-lab.com.cn/uploads
chmod -R 755 /www/wwwroot/www.tht-lab.com.cn/uploads

# 设置文件权限
find /www/wwwroot/www.tht-lab.com.cn/uploads -type f -exec chmod 644 {} \;
find /www/wwwroot/www.tht-lab.com.cn/uploads -type d -exec chmod 755 {} \;
```

### 3. Nginx 配置
图片通过后端 API 访问，不需要额外配置：
- 访问路径：`https://www.tht-lab.com.cn/api/uploads/xxx.jpg`
- 后端映射：`/api/uploads/**` → `/www/wwwroot/www.tht-lab.com.cn/uploads/`

## 🧪 测试步骤

### 1. 图片显示测试
1. 访问前台首页，检查所有图片是否正常显示
2. 访问认证服务页面，检查分类图标和服务图片
3. 访问新闻页面，检查新闻图片
4. 访问荣誉资质页面，检查荣誉图片
5. 访问后台管理页面，检查列表中的图片预览

### 2. 图片上传测试
1. 登录后台管理系统
2. 进入"认证服务管理"，上传封面图片
3. 进入"新闻管理"，上传新闻图片
4. 进入"公司信息管理"，上传 Logo 和二维码
5. 进入"实验室管理"，上传实验室图片
6. 进入"认证分类管理"，上传分类图标
7. 进入"荣誉资质管理"，上传荣誉图片
8. 检查上传后的图片是否正常显示

### 3. 图片替换测试
1. 在后台编辑已有记录
2. 点击"重新上传"按钮
3. 上传新图片
4. 保存后检查图片是否已更新
5. 刷新页面，确认图片已正确替换

## ⚠️ 注意事项

1. **路径格式**：
   - 后端返回的路径格式为：`/uploads/xxx.png`
   - `getImageUrl()` 会自动转换为：`/api/uploads/xxx.png`
   - 如果数据库中已包含 `/api/uploads/`，会自动清理重复

2. **环境变量**：
   - 开发环境：使用 `http://localhost:8082/api`
   - 生产环境：使用 `/api`（相对路径）
   - 可通过 `VITE_API_BASE_URL` 环境变量自定义

3. **缓存控制**：
   - 默认使用路径哈希作为版本号（可缓存）
   - 使用 `'force'` 参数强制刷新（使用时间戳）
   - Logo 等关键图片使用 `'force'` 确保及时更新

4. **文件大小限制**：
   - 前端：建议不超过 10MB
   - 后端：根据 `application.yml` 中的 `spring.servlet.multipart.max-file-size` 配置

## 📝 常见问题

### Q1: 图片显示为空白或 404
**A**: 检查：
1. 图片文件是否存在于服务器 `/www/wwwroot/www.tht-lab.com.cn/uploads/` 目录
2. 文件权限是否正确（644 文件，755 目录）
3. 后端服务是否正常运行
4. Nginx 配置是否正确

### Q2: 上传后图片路径重复（如 `/api/uploads//api/uploads/xxx.png`）
**A**: 已修复，`getImageUrl()` 函数会自动检测并清理重复路径。

### Q3: 线上上传图片失败
**A**: 检查：
1. 后端服务是否正常运行
2. 上传目录权限是否正确
3. 磁盘空间是否充足
4. 后端日志是否有错误信息

### Q4: 替换图片后前台没有更新
**A**: 
1. 检查图片路径是否正确
2. 清除浏览器缓存
3. 使用 `getImageUrl(imagePath, 'force')` 强制刷新

## ✅ 验证清单

- [x] 所有上传 URL 使用环境变量配置
- [x] 所有图片显示使用 `getImageUrl()` 处理
- [x] 图片路径重复问题已修复
- [x] 后端文件存储路径自动判断环境
- [x] 前端图片 URL 处理支持所有格式
- [x] 上传成功后的路径处理正确
- [x] 图片替换功能正常

## 🚀 部署后验证

1. **检查图片显示**：
   - 访问 `https://www.tht-lab.com.cn/`，检查首页图片
   - 访问各个前台页面，检查图片显示

2. **测试图片上传**：
   - 登录后台，尝试上传图片
   - 检查上传后的图片是否正常显示

3. **测试图片替换**：
   - 编辑已有记录，替换图片
   - 检查替换后的图片是否正确更新

4. **检查图片路径**：
   - 打开浏览器开发者工具
   - 检查图片请求的 URL 是否正确
   - 确认没有重复路径问题

