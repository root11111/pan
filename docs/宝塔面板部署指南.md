# 宝塔面板部署指南

## 项目结构
- **后端**: Spring Boot 3.1.5 + Java 17 (端口: 8082, 路径: /api)
- **前端**: Vue 3 + Vite (需要构建后部署)

---

## 一、环境准备

### 1. 安装必要软件

在宝塔面板中安装以下软件：

1. **Java 环境**
   - 进入 `软件商店` → 搜索 `Java项目管理器`
   - 安装并配置 Java 17

2. **MySQL 数据库**
   - 进入 `软件商店` → 安装 `MySQL 8.0` 或更高版本
   - 创建数据库 `zht_lab`
   - 导入数据库脚本（在项目根目录的 `database` 文件夹中）

3. **Nginx**
   - 进入 `软件商店` → 安装 `Nginx`

4. **PM2 管理器**（可选，用于管理后端进程）
   - 进入 `软件商店` → 安装 `PM2管理器`

---

## 二、后端部署

### 1. 上传后端文件

1. 在服务器上创建项目目录：
   ```bash
   /www/wwwroot/zht-lab/
   ```

2. 上传后端 JAR 文件：
   - 将 `backend/target/zht-lab-backend-1.0.0.jar` 上传到服务器
   - 建议路径：`/www/wwwroot/zht-lab/backend/`

### 2. 配置 application.yml

创建配置文件 `/www/wwwroot/zht-lab/backend/application.yml`：

```yaml
server:
  port: 8082
  servlet:
    context-path: /api

spring:
  application:
    name: taihe-lab-backend
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/zht_lab?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: 你的数据库密码
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 50MB

  web:
    resources:
      static-locations: classpath:/static/uploads/
      add-mappings: true

mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    db-config:
      id-type: auto
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.zht.entity

logging:
  level:
    com.zht: info
    org.springframework.web: info
```

### 3. 创建上传目录

```bash
mkdir -p /www/wwwroot/zht-lab/backend/uploads
chmod 755 /www/wwwroot/zht-lab/backend/uploads
```

### 4. 启动后端服务

#### 方法一：使用 Java项目管理器

1. 打开 `Java项目管理器`
2. 点击 `添加Java项目`
3. 配置如下：
   - **项目名称**: zht-lab-backend
   - **项目路径**: /www/wwwroot/zht-lab/backend
   - **项目类型**: Spring Boot
   - **JAR包名称**: zht-lab-backend-1.0.0.jar
   - **运行端口**: 8082
   - **JDK版本**: 17
   - **启动参数**: `--spring.config.location=/www/wwwroot/zht-lab/backend/application.yml`
4. 点击 `启动`

#### 方法二：使用 PM2 管理器

1. 创建启动脚本 `/www/wwwroot/zht-lab/backend/start.sh`：
   ```bash
   #!/bin/bash
   cd /www/wwwroot/zht-lab/backend
   nohup java -jar -Xms512m -Xmx1024m zht-lab-backend-1.0.0.jar --spring.config.location=application.yml > logs/app.log 2>&1 &
   ```

2. 赋予执行权限：
   ```bash
   chmod +x /www/wwwroot/zht-lab/backend/start.sh
   ```

3. 在 PM2 管理器中添加项目：
   - 命令: `/www/wwwroot/zht-lab/backend/start.sh`
   - 工作目录: `/www/wwwroot/zht-lab/backend`

#### 方法三：使用 systemd（推荐）

1. 创建服务文件 `/etc/systemd/system/zht-lab-backend.service`：
   ```ini
   [Unit]
   Description=ZHT Lab Backend Service
   After=network.target mysql.service

   [Service]
   Type=simple
   User=www
   WorkingDirectory=/www/wwwroot/zht-lab/backend
   ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m /www/wwwroot/zht-lab/backend/zht-lab-backend-1.0.0.jar --spring.config.location=/www/wwwroot/zht-lab/backend/application.yml
   Restart=always
   RestartSec=10
   StandardOutput=journal
   StandardError=journal

   [Install]
   WantedBy=multi-user.target
   ```

2. 启动服务：
   ```bash
   systemctl daemon-reload
   systemctl enable zht-lab-backend
   systemctl start zht-lab-backend
   systemctl status zht-lab-backend
   ```

### 5. 验证后端服务

访问：`http://你的服务器IP:8082/api/` 应该能看到响应。

---

## 三、前端部署

### 1. 构建前端项目

在本地开发环境执行：

```bash
cd frontend
npm install
npm run build
```

构建完成后，`frontend/dist` 目录就是需要部署的文件。

### 2. 上传前端文件

1. 将 `frontend/dist` 目录下的所有文件上传到服务器
2. 建议路径：`/www/wwwroot/zht-lab/frontend/`

### 3. 配置 Nginx

在宝塔面板中：

1. 进入 `网站` → `添加站点`
2. 填写域名（如：`www.yourdomain.com`）
3. 根目录设置为：`/www/wwwroot/zht-lab/frontend`
4. PHP版本选择：`纯静态`

5. 点击 `设置` → `配置文件`，修改为以下配置：

```nginx
server {
    listen 80;
    server_name www.yourdomain.com;
    root /www/wwwroot/zht-lab/frontend;
    index index.html;

    # 前端静态文件
    location / {
        try_files $uri $uri/ /index.html;
    }

    # API 代理到后端
    location /api/ {
        proxy_pass http://127.0.0.1:8082;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持（如果需要）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # 超时设置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 静态资源缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml+rss application/json application/javascript;
}
```

6. 如果使用 HTTPS，需要配置 SSL 证书：
   - 在 `网站` → `设置` → `SSL` 中配置证书
   - 或者在 Nginx 配置中添加 HTTPS 配置

### 4. 配置前端 API 地址

如果前端代码中硬编码了 API 地址，需要修改：

检查 `frontend/src/api/index.js`，确保 API 基础地址正确：

```javascript
// 生产环境应该使用相对路径或域名
const baseURL = import.meta.env.PROD 
  ? '/api'  // 生产环境使用相对路径，通过 Nginx 代理
  : 'http://localhost:8082/api'  // 开发环境
```

---

## 四、防火墙配置

在宝塔面板中：

1. 进入 `安全` → `防火墙`
2. 确保以下端口已开放：
   - **80**: HTTP
   - **443**: HTTPS（如果使用 SSL）
   - **8082**: 后端服务（如果需要在外部访问，否则只允许本地访问）

---

## 五、数据库配置

### 1. 创建数据库

1. 进入 `数据库` → `添加数据库`
2. 数据库名：`zht_lab`
3. 用户名和密码：根据实际情况设置
4. 字符集：`utf8mb4`

### 2. 导入数据

1. 进入 `数据库` → 选择 `zht_lab` → `导入`
2. 上传项目中的 SQL 文件（在 `database` 目录中）
3. 按顺序导入：
   - 先导入表结构
   - 再导入数据

### 3. 更新 application.yml

确保 `application.yml` 中的数据库连接信息正确：
- 数据库地址：`localhost:3306`
- 数据库名：`zht_lab`
- 用户名和密码：与宝塔中创建的数据库一致

---

## 六、文件权限配置

确保上传目录有正确的权限：

```bash
# 后端上传目录
chown -R www:www /www/wwwroot/zht-lab/backend/uploads
chmod -R 755 /www/wwwroot/zht-lab/backend/uploads

# 前端目录
chown -R www:www /www/wwwroot/zht-lab/frontend
chmod -R 755 /www/wwwroot/zht-lab/frontend
```

---

## 七、日志管理

### 后端日志

如果使用 systemd，查看日志：
```bash
journalctl -u zht-lab-backend -f
```

或者查看应用日志文件（如果配置了日志文件输出）

### Nginx 日志

在宝塔面板中：
- `网站` → `设置` → `日志` 可以查看访问日志和错误日志

---

## 八、常见问题

### 1. 后端无法启动

- 检查 Java 版本是否为 17
- 检查端口 8082 是否被占用
- 检查数据库连接是否正常
- 查看日志文件排查错误

### 2. 前端无法访问 API

- 检查 Nginx 配置中的 `/api/` 代理是否正确
- 检查后端服务是否正常运行
- 检查防火墙是否开放了 8082 端口

### 3. 静态资源 404

- 检查前端文件是否完整上传
- 检查 Nginx 配置中的 `root` 路径是否正确
- 检查文件权限

### 4. 数据库连接失败

- 检查数据库服务是否启动
- 检查 `application.yml` 中的数据库配置
- 检查数据库用户权限

---

## 九、更新部署

### 更新后端

1. 停止后端服务
2. 备份旧的 JAR 文件
3. 上传新的 JAR 文件
4. 重启服务

### 更新前端

1. 本地重新构建：`npm run build`
2. 备份旧的前端文件
3. 上传新的 `dist` 目录内容
4. 清除浏览器缓存或重启 Nginx

---

## 十、性能优化建议

1. **启用 Nginx 缓存**：对静态资源启用缓存
2. **启用 Gzip 压缩**：已在配置中启用
3. **CDN 加速**：将静态资源放到 CDN
4. **数据库优化**：定期优化数据库表
5. **后端 JVM 调优**：根据服务器配置调整 JVM 参数

---

## 十一、安全建议

1. **修改默认密码**：修改数据库和系统默认密码
2. **配置 SSL 证书**：使用 HTTPS 访问
3. **定期备份**：配置自动备份数据库和文件
4. **防火墙规则**：只开放必要的端口
5. **更新系统**：定期更新系统和软件

---

## 联系支持

如有问题，请查看日志文件或联系技术支持。

