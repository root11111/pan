# 修复 403 Forbidden 和 404 错误

## 错误分析

根据错误日志，主要有以下问题：

### 1. `directory index of "/www/wwwroot/www.tht-lab.com.cn/" is forbidden`
**原因**：Nginx 找不到 `index.html` 文件，或者目录索引被禁用。

**解决方案**：
1. 确认 `index.html` 文件存在于 `/www/wwwroot/www.tht-lab.com.cn/` 目录
2. 检查文件权限
3. 确认 Nginx 配置中的 `index` 和 `root` 设置正确

### 2. `/api` 请求失败
**原因**：`location /api/` 只匹配带斜杠的路径，但请求可能是 `/api`（不带斜杠）。

**解决方案**：使用正则表达式匹配 `/api` 和 `/api/`：
```nginx
location ~ ^/api(/|$) {
    proxy_pass http://127.0.0.1:8082;
    ...
}
```

### 3. `/about` 等路由 404
**原因**：Vue Router 的 `try_files` 配置可能被其他 location 规则覆盖。

**解决方案**：确保 `location /` 放在最后，作为默认处理。

## 修复步骤

### 步骤 1：检查文件是否存在

在服务器上执行：
```bash
# 检查 index.html 是否存在
ls -la /www/wwwroot/www.tht-lab.com.cn/index.html

# 检查目录内容
ls -la /www/wwwroot/www.tht-lab.com.cn/
```

如果 `index.html` 不存在，需要：
1. 在本地执行 `npm run build`
2. 将 `frontend/dist` 目录中的所有文件上传到 `/www/wwwroot/www.tht-lab.com.cn/`

### 步骤 2：检查文件权限

```bash
# 设置正确的文件权限
chown -R www:www /www/wwwroot/www.tht-lab.com.cn
chmod -R 755 /www/wwwroot/www.tht-lab.com.cn
chmod 644 /www/wwwroot/www.tht-lab.com.cn/index.html
```

### 步骤 3：更新 Nginx 配置

使用修复版的配置文件：`docs/宝塔Nginx配置示例-修复版.conf`

**关键修改**：

1. **API 代理配置**（修复 `/api` 和 `/api/` 匹配）：
```nginx
# 修复前
location /api/ {
    ...
}

# 修复后
location ~ ^/api(/|$) {
    proxy_pass http://127.0.0.1:8082;
    ...
}
```

2. **Location 顺序**（确保 Vue Router 支持）：
```nginx
# 顺序很重要：
# 1. 特殊路径（/api, /ws）
# 2. 静态资源
# 3. 默认路由（最后）
location / {
    try_files $uri $uri/ /index.html;
}
```

### 步骤 4：测试配置

```bash
# 测试 Nginx 配置语法
nginx -t
```

如果测试通过，重载 Nginx：
```bash
/etc/init.d/nginx reload
```

### 步骤 5：验证修复

1. **访问首页**：
   - 打开 `https://www.tht-lab.com.cn/`
   - 应该能看到网站首页，而不是 403 错误

2. **测试前端路由**：
   - 访问 `https://www.tht-lab.com.cn/about`
   - 应该能正常显示，而不是 404 错误

3. **测试 API**：
   - 打开浏览器开发者工具（F12）
   - 访问后台登录页：`https://www.tht-lab.com.cn/admin/login`
   - 查看 Network 标签，API 请求应该成功

## 常见问题排查

### 问题 1：仍然显示 403 Forbidden

**检查清单**：
- [ ] `index.html` 文件是否存在？
- [ ] 文件权限是否正确？（644）
- [ ] 目录权限是否正确？（755）
- [ ] Nginx 配置中的 `root` 路径是否正确？
- [ ] Nginx 配置中的 `index` 是否包含 `index.html`？

**命令检查**：
```bash
# 检查文件
ls -la /www/wwwroot/www.tht-lab.com.cn/index.html

# 检查权限
stat /www/wwwroot/www.tht-lab.com.cn/index.html

# 检查 Nginx 配置
nginx -t
```

### 问题 2：API 请求仍然失败

**检查清单**：
- [ ] 后端服务是否在 8082 端口运行？
- [ ] Nginx 配置中的 `location ~ ^/api(/|$)` 是否正确？
- [ ] 是否重载了 Nginx 配置？

**测试后端服务**：
```bash
# 检查后端服务是否运行
netstat -tlnp | grep 8082

# 或者
curl http://127.0.0.1:8082/api/admin/login
```

### 问题 3：前端路由仍然 404

**检查清单**：
- [ ] `location /` 是否放在配置的最后？
- [ ] `try_files $uri $uri/ /index.html;` 是否正确？
- [ ] 是否有其他 location 规则覆盖了根路径？

**检查配置顺序**：
```nginx
# 正确的顺序：
location ~ ^/api(/|$) { ... }      # 1. API 代理
location /ws { ... }                # 2. WebSocket
location ~ .*\.(gif|jpg|...)$ { ... }  # 3. 静态资源
location / { ... }                  # 4. 默认路由（最后）
```

## 忽略的错误

以下错误是正常的，可以忽略（扫描器/机器人的请求）：
- `/graphql` - 扫描器请求
- `/actuator/env` - 扫描器请求
- `/server-status` - 扫描器请求
- `/.vscode/sftp.json` - 扫描器请求
- `/favicon.ico` - 如果不存在可以忽略，或者添加一个 favicon.ico 文件

## 完整检查清单

部署前确认：
- [x] `index.html` 文件存在
- [x] 文件权限正确（644）
- [x] 目录权限正确（755）
- [x] Nginx 配置已更新
- [x] Nginx 配置测试通过
- [x] Nginx 已重载
- [x] 后端服务正常运行
- [x] 网站可以正常访问
- [x] 前端路由正常工作
- [x] API 请求正常

## 如果问题仍然存在

1. **查看详细错误日志**：
```bash
tail -f /www/wwwlogs/www.tht-lab.com.cn.error.log
```

2. **检查访问日志**：
```bash
tail -f /www/wwwlogs/www.tht-lab.com.cn.log
```

3. **检查 Nginx 配置**：
```bash
nginx -T | grep -A 20 "server_name www.tht-lab.com.cn"
```

4. **重启 Nginx**（如果重载不行）：
```bash
/etc/init.d/nginx restart
```

