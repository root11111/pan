# 宝塔面板快速部署指南

## 一、准备工作

### 1. 上传文件

**前端文件：**
- 在本地执行 `cd frontend && npm run build`
- 将 `frontend/dist` 目录下的所有文件上传到 `/www/wwwroot/tht-lab.com.cn/`

**后端文件：**
- 将 `backend/target/zht-lab-backend-1.0.0.jar` 上传到服务器（建议路径：`/www/wwwroot/zht-lab/backend/`）

### 2. 创建配置文件

在服务器上创建 `/www/wwwroot/zht-lab/backend/application.yml`：

```yaml
server:
  port: 8082
  servlet:
    context-path: /api

spring:
  application:
    name: taihe-lab-backend
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/zht_lab?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai&allowPublicKeyRetrieval=true
    username: root
    password: 你的数据库密码
    druid:
      initial-size: 5
      min-idle: 5
      max-active: 20
      max-wait: 60000
      time-between-eviction-runs-millis: 60000
      min-evictable-idle-time-millis: 300000
      validation-query: SELECT 1
      test-while-idle: true
      test-on-borrow: false
      test-on-return: false

  servlet:
    multipart:
      enabled: true
      max-file-size: 10MB
      max-request-size: 50MB

  web:
    resources:
      static-locations: classpath:/static/uploads/
      add-mappings: true

mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true
  global-config:
    db-config:
      id-type: auto
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.zht.entity

logging:
  level:
    com.zht: info
    org.springframework.web: info
```

**重要：** 请修改数据库密码！

### 3. 创建上传目录

```bash
mkdir -p /www/wwwroot/zht-lab/backend/uploads
chown -R www:www /www/wwwroot/zht-lab/backend/uploads
chmod -R 755 /www/wwwroot/zht-lab/backend/uploads
```

---

## 二、配置 Nginx

### 方法一：在宝塔面板中修改

1. 进入宝塔面板 → `网站` → 找到 `tht-lab.com.cn` → 点击 `设置`
2. 点击 `配置文件` 标签
3. 将配置文件内容替换为 `docs/宝塔Nginx配置示例.conf` 中的内容
4. 点击 `保存`

### 方法二：直接编辑配置文件

编辑文件：`/www/server/panel/vhost/nginx/tht-lab.com.cn.conf`

将内容替换为 `docs/宝塔Nginx配置示例.conf` 中的配置。

然后重启 Nginx：
```bash
/etc/init.d/nginx reload
```

---

## 三、启动后端服务

### 使用 Java项目管理器（推荐）

1. 在宝塔面板打开 `Java项目管理器`
2. 点击 `添加Java项目`
3. 配置如下：
   - **项目名称**: zht-lab-backend
   - **项目路径**: /www/wwwroot/zht-lab/backend
   - **项目类型**: Spring Boot
   - **JAR包名称**: zht-lab-backend-1.0.0.jar
   - **运行端口**: 8082
   - **JDK版本**: 17
   - **启动参数**: `--spring.config.location=/www/wwwroot/zht-lab/backend/application.yml`
4. 点击 `启动`

### 使用 systemd（可选）

创建服务文件 `/etc/systemd/system/zht-lab-backend.service`：

```ini
[Unit]
Description=ZHT Lab Backend Service
After=network.target mysql.service

[Service]
Type=simple
User=www
WorkingDirectory=/www/wwwroot/zht-lab/backend
ExecStart=/usr/bin/java -jar -Xms512m -Xmx1024m /www/wwwroot/zht-lab/backend/zht-lab-backend-1.0.0.jar --spring.config.location=/www/wwwroot/zht-lab/backend/application.yml
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

启动服务：
```bash
systemctl daemon-reload
systemctl enable zht-lab-backend
systemctl start zht-lab-backend
systemctl status zht-lab-backend
```

---

## 四、配置数据库

1. 在宝塔面板 → `数据库` → `添加数据库`
   - 数据库名：`zht_lab`
   - 字符集：`utf8mb4`

2. 导入 SQL 文件
   - 进入数据库管理 → 选择 `zht_lab` → `导入`
   - 上传项目中的 SQL 文件（在 `database` 目录中）

3. 更新 `application.yml` 中的数据库密码

---

## 五、验证部署

1. **检查后端服务**
   ```bash
   curl http://127.0.0.1:8082/api/
   ```

2. **检查前端**
   - 访问：`https://tht-lab.com.cn`
   - 应该能看到网站首页

3. **检查 API 代理**
   - 打开浏览器开发者工具
   - 查看 Network 标签
   - 访问网站，检查 `/api/` 请求是否正常

---

## 六、常见问题

### 1. 前端显示正常但 API 请求失败

**检查：**
- 后端服务是否启动：`systemctl status zht-lab-backend` 或查看 Java项目管理器
- Nginx 配置中的 `/api/` 代理是否正确
- 防火墙是否开放 8082 端口（后端只需要本地访问，不需要对外开放）

### 2. 404 错误

**检查：**
- 前端文件是否完整上传到 `/www/wwwroot/tht-lab.com.cn/`
- Nginx 配置中的 `root` 路径是否正确
- 是否有 `try_files $uri $uri/ /index.html;` 配置

### 3. 后端无法启动

**检查：**
- Java 版本是否为 17：`java -version`
- 端口 8082 是否被占用：`netstat -tlnp | grep 8082`
- 数据库连接是否正常
- 查看日志：`journalctl -u zht-lab-backend -f` 或查看 Java项目管理器中的日志

### 4. 静态资源加载慢

**优化：**
- 已配置 Gzip 压缩
- 已配置静态资源缓存
- 可以考虑使用 CDN

---

## 七、更新部署

### 更新前端

1. 本地构建：`cd frontend && npm run build`
2. 备份旧文件（可选）
3. 上传新的 `dist` 目录内容到 `/www/wwwroot/tht-lab.com.cn/`
4. 清除浏览器缓存

### 更新后端

1. 停止后端服务
2. 备份旧的 JAR 文件
3. 上传新的 JAR 文件
4. 重启服务

---

## 八、文件权限

确保文件权限正确：

```bash
# 前端目录
chown -R www:www /www/wwwroot/tht-lab.com.cn
chmod -R 755 /www/wwwroot/tht-lab.com.cn

# 后端目录
chown -R www:www /www/wwwroot/zht-lab/backend
chmod -R 755 /www/wwwroot/zht-lab/backend
chmod -R 755 /www/wwwroot/zht-lab/backend/uploads
```

---

## 九、安全建议

1. ✅ 修改数据库默认密码
2. ✅ 使用 HTTPS（已配置 SSL）
3. ✅ 定期备份数据库和文件
4. ✅ 只开放必要的端口（80, 443）
5. ✅ 定期更新系统和软件

---

## 配置要点总结

1. **前端路径**: `/www/wwwroot/tht-lab.com.cn/`（指向 dist 目录）
2. **后端端口**: 8082（仅本地访问）
3. **API 代理**: `/api/` → `http://127.0.0.1:8082`
4. **前端路由**: 使用 `try_files` 支持 Vue Router
5. **静态资源**: 已配置缓存和 Gzip 压缩

完成以上步骤后，网站应该可以正常访问了！

